<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord æ©Ÿå™¨äººæ§åˆ¶å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', -apple-system, sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            color: #fff;
        }

        .navbar {
            background: #2b2b2b;
            border-bottom: 1px solid #333;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2563eb;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #2563eb;
        }

        .user-name {
            color: #ccc;
        }

        .logout-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: #b91c1c;
        }

        .hamburger {
            display: none;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            padding: 8px;
            background: none;
            border: none;
            margin-right: 1rem;
        }

        .hamburger span {
            width: 24px;
            height: 3px;
            background: #fff;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .hamburger.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .hamburger.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .main-layout {
            display: flex;
            height: calc(100vh - 73px);
        }

        .sidebar {
            width: 280px;
            background: #2b2b2b;
            border-right: 1px solid #333;
            overflow-y: auto;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 999;
        }

        .sidebar-item {
            padding: 1rem 1.5rem;
            color: #ccc;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
        }

        .sidebar-item:hover {
            background: #1a1a1a;
            color: #fff;
        }

        .sidebar-item.active {
            background: #1a1a1a;
            border-left-color: #2563eb;
            color: #2563eb;
        }

        .sidebar-section {
            padding: 0.75rem 1.5rem;
            color: #666;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-top: 1rem;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .content-section {
            width: 100%;
        }

        .container {
            max-width: 100%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #2b2b2b;
            padding: 1.5rem;
            border-left: 4px solid #2563eb;
        }

        .stat-label {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #2563eb;
        }

        .section {
            background: #2b2b2b;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #fff;
            border-bottom: 2px solid #333;
            padding-bottom: 0.5rem;
        }

        .guild-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .guild-item {
            background: #1a1a1a;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid #333;
        }

        .guild-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .guild-info {
            flex: 1;
        }

        .guild-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .guild-members {
            color: #888;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #888;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .feature-item {
            background: #1a1a1a;
            padding: 1rem;
            border: 1px solid #333;
            text-align: center;
        }

        .feature-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .feature-label {
            color: #ccc;
            font-size: 0.9rem;
        }

        .btn {
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ç§»å‹•ç«¯éŸ¿æ‡‰å¼æ¨£å¼ */
        @media (max-width: 768px) {
            .hamburger {
                display: flex;
            }

            .navbar {
                padding: 1rem;
            }

            .navbar-brand {
                font-size: 1rem;
            }

            .navbar-brand span {
                display: none;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
            }

            .user-name {
                display: none;
            }

            .sidebar {
                position: fixed;
                top: 73px;
                left: 0;
                bottom: 0;
                transform: translateX(-100%);
                box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .section {
                padding: 1rem;
            }

            .section-title {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .logout-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <button class="hamburger" onclick="toggleSidebar()" aria-label="åˆ‡æ›èœå–®">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="navbar-brand">
            Discord Bot Dashboard
            <span style="margin-left: 1rem; color: #888; font-size: 0.9rem;">/ {GUILD_NAME}</span>
        </div>
        <div class="navbar-user">
            <a href="/my-tickets" style="color: #2563eb; text-decoration: none; margin-right: 1rem;">ğŸ« æˆ‘çš„å®¢æœå–®</a>
            <a href="/select-server" style="color: #2563eb; text-decoration: none; margin-right: 1rem;">â† è¿”å›ä¼ºæœå™¨åˆ—è¡¨</a>
            <img src="{AVATAR_URL}" alt="Avatar" class="user-avatar">
            <span class="user-name">{USERNAME}</span>
            <a href="/logout" class="logout-btn">ç™»å‡º</a>
        </div>
    </div>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="main-layout">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-section">æ•¸æ“šç¸½è¦½</div>
            <div class="sidebar-item active" onclick="showSection('dashboard')">
                å„€è¡¨æ¿
            </div>
            <div class="sidebar-item" onclick="showSection('levels')">
                ç­‰ç´šç³»çµ±
            </div>
            <div class="sidebar-item" onclick="showSection('daily')">
                ç°½åˆ°ç³»çµ±
            </div>
            <div class="sidebar-item" onclick="showSection('birthdays')">
                ç”Ÿæ—¥ç³»çµ±
            </div>
            <div class="sidebar-item" onclick="showSection('games')">
                éŠæˆ²ç³»çµ±
            </div>
            <div class="sidebar-item" onclick="showSection('statistics')">
                æ´»èºåº¦åˆ†æ
            </div>
            
            <div class="sidebar-section">ç³»çµ±ç®¡ç†</div>
            <div class="sidebar-item" onclick="showSection('warnings')">
                è­¦å‘Šç®¡ç†
            </div>
            <div class="sidebar-item" onclick="showSection('achievements')">
                æˆå°±ç®¡ç†
            </div>
            <div class="sidebar-item" onclick="showSection('tickets')">
                å®¢æœå–®ç®¡ç†
            </div>
            <div class="sidebar-item" onclick="showSection('custom-commands')">
                è‡ªå®šç¾©å‘½ä»¤
            </div>
            
            <div class="sidebar-section">ç³»çµ±è¨­å®š</div>
            <div class="sidebar-item" onclick="showSection('welcome')">
                æ­¡è¿ç³»çµ±
            </div>
            <div class="sidebar-item" onclick="showSection('temp-voice')">
                è‡¨æ™‚èªéŸ³
            </div>
            <div class="sidebar-item" onclick="showSection('auto-reply')">
                è‡ªå‹•å›è¦†
            </div>
        </div>

        <div class="content">
            <div id="section-dashboard" class="content-section">
                <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">æˆå“¡æ•¸é‡</div>
                <div class="stat-value" id="member-count">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">é »é“æ•¸é‡</div>
                <div class="stat-value" id="channel-count">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">èº«åˆ†çµ„æ•¸é‡</div>
                <div class="stat-value" id="role-count">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ–‡å­—é »é“</div>
                <div class="stat-value" id="text-channels">-</div>
            </div>
        </div>
            </div>

            <!-- ç­‰ç´šç³»çµ± -->
            <div id="section-levels" class="content-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">ç­‰ç´šç³»çµ±æ•¸æ“š</h2>
                    <div id="levels-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- ç°½åˆ°ç³»çµ± -->
            <div id="section-daily" class="content-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">ç°½åˆ°ç³»çµ±æ•¸æ“š</h2>
                    <div id="daily-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- ç”Ÿæ—¥ç³»çµ± -->
            <div id="section-birthdays" class="content-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">ç”Ÿæ—¥ç³»çµ±æ•¸æ“š</h2>
                    <div id="birthday-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- éŠæˆ²ç³»çµ± -->
            <div id="section-games" class="content-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">éŠæˆ²ç³»çµ±æ•¸æ“š</h2>
                    <div id="game-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- æ´»èºåº¦åˆ†æ -->
            <div id="section-statistics" class="content-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">ä¼ºæœå™¨æ´»èºåº¦</h2>
                    <div id="statistics-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- è­¦å‘Šç®¡ç† -->
            <div id="section-warnings" class="content-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">è­¦å‘Šç³»çµ±ç®¡ç†</h2>
                    <div id="warnings-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- æˆå°±ç®¡ç† -->
            <div id="section-achievements" class="content-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">æˆå°±ç³»çµ±ç®¡ç†</h2>
                    <div id="achievements-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- è‡ªå®šç¾©å‘½ä»¤ -->
            <div id="section-custom-commands" class="content-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">è‡ªå®šç¾©å‘½ä»¤ç®¡ç†</h2>
                    <div id="custom-commands-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- æ­¡è¿ç³»çµ± -->
            <div id="section-welcome" class="content-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">æ­¡è¿ç³»çµ±è¨­å®š</h2>
                    <div id="welcome-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- è‡¨æ™‚èªéŸ³ -->
            <div id="section-temp-voice" class="content-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">è‡¨æ™‚èªéŸ³é »é“è¨­å®š</h2>
                    <div id="temp-voice-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- å®¢æœå–®ç®¡ç† -->
            <div id="section-tickets" class="content-section" style="display: none;">
                <div class="section">
                    <h2 class="section-title">å®¢æœå–®ç³»çµ±ç®¡ç†</h2>
                    <div id="tickets-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>

            <!-- è‡ªå‹•å›è¦†ç³»çµ± -->
            <div id="section-auto-reply" class="content-section" style="display: none;">
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 class="section-title" style="margin: 0;">è‡ªå‹•å›è¦†ç®¡ç†</h2>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; color: #ccc;">
                                <span id="auto-reply-system-status">ç³»çµ±ç‹€æ…‹</span>
                                <input type="checkbox" id="auto-reply-system-toggle" onchange="toggleAutoReplySystem(this.checked)"
                                       style="width: 44px; height: 22px;">
                            </label>
                            <button class="action-btn" onclick="openAddAutoReplyModal()" 
                                    style="background: #2563eb; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
                                â• æ·»åŠ è¦å‰‡
                            </button>
                        </div>
                    </div>
                    <div id="auto-reply-data" style="color: #888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç·¨è¼¯è‡ªå‹•å›è¦†è¦å‰‡çš„æ¨¡æ…‹æ¡† -->
    <div id="autoReplyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: #2b2b2b; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 id="modalTitle" style="margin: 0; color: #fff;">æ·»åŠ è‡ªå‹•å›è¦†è¦å‰‡</h3>
                <button onclick="closeAutoReplyModal()" style="background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer;">âœ•</button>
            </div>
            
            <input type="hidden" id="editRuleId" value="">
            
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- è§¸ç™¼è© -->
                <div>
                    <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">è§¸ç™¼è©</label>
                    <input type="text" id="triggerInput" placeholder="è¼¸å…¥è§¸ç™¼é—œéµè©" 
                           style="width: 100%; padding: 0.75rem; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #fff;">
                </div>
                
                <!-- å›è¦†å…§å®¹ -->
                <div>
                    <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">å›è¦†å…§å®¹</label>
                    <textarea id="replyInput" rows="3" placeholder="è¼¸å…¥å›è¦†å…§å®¹&#10;&#10;å¯ç”¨è®Šé‡: {user} {username} {server} {channel}" 
                              style="width: 100%; padding: 0.75rem; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #fff; resize: vertical;"></textarea>
                </div>
                
                <!-- åŒ¹é…é¡å‹ -->
                <div>
                    <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">åŒ¹é…é¡å‹</label>
                    <select id="matchTypeSelect" style="width: 100%; padding: 0.75rem; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #fff;">
                        <option value="contains">åŒ…å«é—œéµè©</option>
                        <option value="exact">å®Œå…¨åŒ¹é…</option>
                        <option value="starts_with">ä»¥...é–‹é ­</option>
                        <option value="ends_with">ä»¥...çµå°¾</option>
                        <option value="regex">æ­£å‰‡è¡¨é”å¼</option>
                    </select>
                </div>
                
                <!-- å›è¦†é¡å‹ -->
                <div>
                    <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">å›è¦†é¡å‹</label>
                    <select id="replyTypeSelect" style="width: 100%; padding: 0.75rem; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #fff;" onchange="toggleReactionInput(this.value)">
                        <option value="message">æ™®é€šæ¶ˆæ¯</option>
                        <option value="reply">å›è¦†æ¶ˆæ¯</option>
                        <option value="dm">ç§è¨Šç”¨æˆ¶</option>
                        <option value="react">æ·»åŠ åæ‡‰</option>
                    </select>
                </div>
                
                <!-- åæ‡‰ Emojiï¼ˆåƒ…åœ¨å›è¦†é¡å‹ç‚º react æ™‚é¡¯ç¤ºï¼‰ -->
                <div id="reactionInputDiv" style="display: none;">
                    <label style="display: block; color: #ccc; margin-bottom: 0.5rem;">åæ‡‰ Emoji</label>
                    <input type="text" id="reactionInput" placeholder="è¼¸å…¥ Emojiï¼Œä¾‹å¦‚ï¼šğŸ‘" value="ğŸ‘"
                           style="width: 100%; padding: 0.75rem; background: #1a1a1a; border: 1px solid #444; border-radius: 4px; color: #fff;">
                </div>
                
                <!-- é¸é … -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #ccc;">
                        <input type="checkbox" id="caseSensitiveCheck">
                        å€åˆ†å¤§å°å¯«
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #ccc;">
                        <input type="checkbox" id="mentionUserCheck">
                        æåŠç”¨æˆ¶
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #ccc;">
                        <input type="checkbox" id="triggerOnceCheck">
                        åªè§¸ç™¼ä¸€æ¬¡
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: #ccc;">
                        <input type="checkbox" id="enabledCheck" checked>
                        å•Ÿç”¨è¦å‰‡
                    </label>
                </div>
                
                <!-- æŒ‰éˆ• -->
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button onclick="saveAutoReply()" 
                            style="flex: 1; padding: 0.75rem; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                        ä¿å­˜
                    </button>
                    <button onclick="closeAutoReplyModal()" 
                            style="flex: 1; padding: 0.75rem; background: #444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GUILD_ID = '{GUILD_ID}';
        
        // æ¼¢å ¡èœå–®åˆ‡æ›å‡½æ•¸
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const hamburger = document.querySelector('.hamburger');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            hamburger.classList.toggle('active');
        }
        
        // å´é‚Šæ¬„åˆ‡æ›å‡½æ•¸
        function showSection(sectionName) {
            // éš±è—æ‰€æœ‰section
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // ç§»é™¤æ‰€æœ‰activeç‹€æ…‹
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            sidebarItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„section
            const targetSection = document.getElementById('section-' + sectionName);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // æ·»åŠ activeç‹€æ…‹åˆ°é»æ“Šçš„é …ç›®
            event.currentTarget.classList.add('active');
            
            // ç§»å‹•ç«¯ï¼šåˆ‡æ›é é¢å¾Œè‡ªå‹•é—œé–‰å´é‚Šæ¬„
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                const hamburger = document.querySelector('.hamburger');
                
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                hamburger.classList.remove('active');
            }
        }
        
        // è¼‰å…¥çµ±è¨ˆæ•¸æ“š
        async function loadStats() {
            try {
                const response = await fetch('/api/stats/' + GUILD_ID);
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('member-count').textContent = stats.member_count.toLocaleString();
                    document.getElementById('channel-count').textContent = stats.channel_count;
                    document.getElementById('role-count').textContent = stats.role_count;
                    document.getElementById('text-channels').textContent = stats.text_channels;
                }
            } catch (error) {
                console.error('è¼‰å…¥çµ±è¨ˆæ•¸æ“šå¤±æ•—:', error);
            }
        }

        // è¼‰å…¥ç­‰ç´šæ•¸æ“š
        async function loadLevels() {
            try {
                const response = await fetch('/api/data/' + GUILD_ID + '/levels');
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('levels-data');
                    
                    if (!data.exists || Object.keys(data.data).length === 0) {
                        container.innerHTML = '<p style="color: #888;">æš«ç„¡ç­‰ç´šæ•¸æ“š</p>';
                        return;
                    }
                    
                    // è¨ˆç®—çµ±è¨ˆ
                    const users = Object.keys(data.data).length;
                    const totalXP = Object.values(data.data).reduce((sum, user) => sum + (user.xp || 0), 0);
                    const totalMessages = Object.values(data.data).reduce((sum, user) => sum + (user.messages || 0), 0);
                    
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">è¨»å†Šç”¨æˆ¶</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${users}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">ç¸½ç¶“é©—å€¼</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${totalXP.toLocaleString()}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">ç¸½è¨Šæ¯æ•¸</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${totalMessages.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('levels-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // è¼‰å…¥ç°½åˆ°æ•¸æ“š
        async function loadDaily() {
            try {
                const response = await fetch('/api/data/' + GUILD_ID + '/daily');
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('daily-data');
                    
                    if (!data.exists || Object.keys(data.data).length === 0) {
                        container.innerHTML = '<p style="color: #888;">æš«ç„¡ç°½åˆ°æ•¸æ“š</p>';
                        return;
                    }
                    
                    const users = Object.keys(data.data).length;
                    const totalCheckins = Object.values(data.data).reduce((sum, user) => sum + (user.total_checkins || 0), 0);
                    const totalPoints = Object.values(data.data).reduce((sum, user) => sum + (user.total_points || 0), 0);
                    
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">ç°½åˆ°ç”¨æˆ¶</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${users}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">ç¸½ç°½åˆ°æ¬¡æ•¸</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${totalCheckins.toLocaleString()}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">ç¸½ç©åˆ†</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${totalPoints.toLocaleString()}</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('daily-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // è¼‰å…¥æ­¡è¿ç³»çµ±è¨­å®š
        async function loadWelcome() {
            try {
                const response = await fetch('/api/data/' + GUILD_ID + '/welcome');
                const channelsResponse = await fetch('/api/channels/' + GUILD_ID);
                
                if (response.ok && channelsResponse.ok) {
                    const data = await response.json();
                    const channels = await channelsResponse.json();
                    const container = document.getElementById('welcome-data');
                    
                    // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜èªå€¼
                    const settings = data.exists ? data.data : {
                        welcome_enabled: false,
                        leave_enabled: false,
                        welcome_channel: null,
                        leave_channel: null,
                        welcome_message: 'æ­¡è¿ {user} åŠ å…¥ {server}ï¼',
                        leave_message: '{username} é›¢é–‹äº†ä¼ºæœå™¨'
                    };
                    
                    const welcomeChecked = settings.welcome_enabled ? 'checked' : '';
                    const leaveChecked = settings.leave_enabled ? 'checked' : '';
                    const welcomeStatusColor = settings.welcome_enabled ? '#2563eb' : '#6b7280';
                    const leaveStatusColor = settings.leave_enabled ? '#2563eb' : '#6b7280';
                    
                    // ç”Ÿæˆé »é“é¸é …
                    const textChannels = channels.text_channels || [];
                    let welcomeChannelOptions = '<option value="">æœªè¨­å®š</option>';
                    let leaveChannelOptions = '<option value="">æœªè¨­å®š</option>';
                    
                    textChannels.forEach(channel => {
                        const welcomeSelected = settings.welcome_channel && settings.welcome_channel == channel.id ? 'selected' : '';
                        const leaveSelected = settings.leave_channel && settings.leave_channel == channel.id ? 'selected' : '';
                        welcomeChannelOptions += `<option value="${channel.id}" ${welcomeSelected}>${channel.name}</option>`;
                        leaveChannelOptions += `<option value="${channel.id}" ${leaveSelected}>${channel.name}</option>`;
                    });
                    
                    container.innerHTML = `
                        ${!data.exists ? '<div style="background: #2b2b2b; padding: 0.75rem; margin-bottom: 1rem; border-left: 3px solid #888; color: #888; font-size: 0.9rem;">ä½¿ç”¨é»˜èªé…ç½®ï¼ˆä¿®æ”¹å¾Œå°‡è‡ªå‹•å‰µå»ºé…ç½®æ–‡ä»¶ï¼‰</div>' : ''}
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                            <!-- æ­¡è¿ç³»çµ± -->
                            <div style="background: #1a1a1a; padding: 1.25rem; border-left: 3px solid ${welcomeStatusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div style="color: #fff; font-size: 1rem; font-weight: 600;">æ­¡è¿ç³»çµ±</div>
                                    <label style="position: relative; display: inline-block; width: 44px; height: 22px; cursor: pointer;">
                                        <input type="checkbox" id="welcome-toggle" ${welcomeChecked} 
                                               onchange="toggleWelcome('welcome', this.checked)"
                                               style="opacity: 0; width: 0; height: 0;">
                                        <span style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                                                     background: ${settings.welcome_enabled ? '#333' : '#2b2b2b'}; 
                                                     transition: 0.2s; border: 1px solid ${settings.welcome_enabled ? '#2563eb' : '#444'};">
                                            <span style="position: absolute; height: 14px; width: 14px; left: ${settings.welcome_enabled ? '26px' : '4px'}; 
                                                         top: 3px; background: ${settings.welcome_enabled ? '#2563eb' : '#666'}; transition: 0.2s;"></span>
                                        </span>
                                    </label>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <span style="color: ${welcomeStatusColor}; font-weight: 500; font-size: 0.9rem;">${settings.welcome_enabled ? 'âœ“ å·²é–‹å•Ÿ' : 'â—‹ å·²é—œé–‰'}</span>
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">æ­¡è¿é »é“</label>
                                    <select id="welcome-channel" style="width: 100%; padding: 0.5rem; background: #2b2b2b; border: 1px solid #333; color: #ccc;">
                                        ${welcomeChannelOptions}
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">æ­¡è¿è¨Šæ¯</label>
                                    <textarea id="welcome-message" rows="3" style="width: 100%; padding: 0.5rem; background: #2b2b2b; border: 1px solid #333; color: #ccc; resize: vertical; font-family: inherit;">${settings.welcome_message}</textarea>
                                    <div style="color: #666; font-size: 0.75rem; margin-top: 0.25rem;">
                                        å¯ç”¨è®Šæ•¸ï¼š{user} {username} {server}
                                    </div>
                                </div>
                                
                                <button onclick="saveWelcomeSettings('welcome')" class="btn btn-primary" style="width: 100%;">
                                    ä¿å­˜è¨­å®š
                                </button>
                            </div>
                            
                            <!-- é›¢é–‹ç³»çµ± -->
                            <div style="background: #1a1a1a; padding: 1.25rem; border-left: 3px solid ${leaveStatusColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div style="color: #fff; font-size: 1rem; font-weight: 600;">é›¢é–‹ç³»çµ±</div>
                                    <label style="position: relative; display: inline-block; width: 44px; height: 22px; cursor: pointer;">
                                        <input type="checkbox" id="leave-toggle" ${leaveChecked} 
                                               onchange="toggleWelcome('leave', this.checked)"
                                               style="opacity: 0; width: 0; height: 0;">
                                        <span style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
                                                     background: ${settings.leave_enabled ? '#333' : '#2b2b2b'}; 
                                                     transition: 0.2s; border: 1px solid ${settings.leave_enabled ? '#2563eb' : '#444'};">
                                            <span style="position: absolute; height: 14px; width: 14px; left: ${settings.leave_enabled ? '26px' : '4px'}; 
                                                         top: 3px; background: ${settings.leave_enabled ? '#2563eb' : '#666'}; transition: 0.2s;"></span>
                                        </span>
                                    </label>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <span style="color: ${leaveStatusColor}; font-weight: 500; font-size: 0.9rem;">${settings.leave_enabled ? 'âœ“ å·²é–‹å•Ÿ' : 'â—‹ å·²é—œé–‰'}</span>
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">é›¢é–‹é »é“</label>
                                    <select id="leave-channel" style="width: 100%; padding: 0.5rem; background: #2b2b2b; border: 1px solid #333; color: #ccc;">
                                        ${leaveChannelOptions}
                                    </select>
                                </div>
                                
                                <div style="margin-bottom: 1rem;">
                                    <label style="display: block; color: #888; font-size: 0.85rem; margin-bottom: 0.5rem;">é›¢é–‹è¨Šæ¯</label>
                                    <textarea id="leave-message" rows="3" style="width: 100%; padding: 0.5rem; background: #2b2b2b; border: 1px solid #333; color: #ccc; resize: vertical; font-family: inherit;">${settings.leave_message}</textarea>
                                    <div style="color: #666; font-size: 0.75rem; margin-top: 0.25rem;">
                                        å¯ç”¨è®Šæ•¸ï¼š{user} {username} {server}
                                    </div>
                                </div>
                                
                                <button onclick="saveWelcomeSettings('leave')" class="btn btn-primary" style="width: 100%;">
                                    ä¿å­˜è¨­å®š
                                </button>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('welcome-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // åˆ‡æ›æ­¡è¿ç³»çµ±é–‹é—œ
        async function toggleWelcome(type, enabled) {
            try {
                const response = await fetch('/api/welcome/' + GUILD_ID + '/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: type,
                        enabled: enabled
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // é‡æ–°è¼‰å…¥æ­¡è¿ç³»çµ±è¨­å®šä»¥æ›´æ–°UI
                        loadWelcome();
                        
                        // é¡¯ç¤ºæˆåŠŸæç¤º
                        const statusText = enabled ? 'å·²é–‹å•Ÿ' : 'å·²é—œé–‰';
                        const typeText = type === 'welcome' ? 'æ­¡è¿ç³»çµ±' : 'é›¢é–‹ç³»çµ±';
                        showNotification(`${typeText}${statusText}`, 'success');
                    }
                } else {
                    showNotification('è¨­å®šæ›´æ–°å¤±æ•—', 'error');
                    // æ¢å¾©é–‹é—œç‹€æ…‹
                    loadWelcome();
                }
            } catch (error) {
                console.error('åˆ‡æ›å¤±æ•—:', error);
                showNotification('ç™¼ç”ŸéŒ¯èª¤', 'error');
                // æ¢å¾©é–‹é—œç‹€æ…‹
                loadWelcome();
            }
        }

        // ä¿å­˜æ­¡è¿ç³»çµ±è¨­å®š
        async function saveWelcomeSettings(type) {
            try {
                let channel, message;
                
                if (type === 'welcome') {
                    channel = document.getElementById('welcome-channel').value;
                    message = document.getElementById('welcome-message').value;
                } else {
                    channel = document.getElementById('leave-channel').value;
                    message = document.getElementById('leave-message').value;
                }
                
                // é©—è­‰
                if (!message.trim()) {
                    showNotification('è¨Šæ¯å…§å®¹ä¸èƒ½ç‚ºç©º', 'error');
                    return;
                }
                
                // æº–å‚™æ•¸æ“š
                const updateData = {};
                if (type === 'welcome') {
                    updateData['welcome_channel'] = channel || null;
                    updateData['welcome_message'] = message;
                } else {
                    updateData['leave_channel'] = channel || null;
                    updateData['leave_message'] = message;
                }
                
                const response = await fetch('/api/welcome/' + GUILD_ID + '/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const typeText = type === 'welcome' ? 'æ­¡è¿ç³»çµ±' : 'é›¢é–‹ç³»çµ±';
                        showNotification(`${typeText}è¨­å®šå·²ä¿å­˜`, 'success');
                        loadWelcome();
                    }
                } else {
                    showNotification('ä¿å­˜å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±æ•—:', error);
                showNotification('ç™¼ç”ŸéŒ¯èª¤', 'error');
            }
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 0.875rem 1.25rem;
                background: ${type === 'success' ? '#2563eb' : '#dc2626'};
                color: white;
                font-size: 0.9rem;
                font-weight: 500;
                border-left: 3px solid ${type === 'success' ? '#1d4ed8' : '#b91c1c'};
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            // 3ç§’å¾Œç§»é™¤
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // è¼‰å…¥ç”Ÿæ—¥æ•¸æ“š
        async function loadBirthdays() {
            try {
                const response = await fetch('/api/data/' + GUILD_ID + '/birthdays');
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('birthday-data');
                    
                    if (!data.exists || Object.keys(data.data).length === 0) {
                        container.innerHTML = '<p style="color: #888;">æš«ç„¡ç”Ÿæ—¥è¨˜éŒ„</p>';
                        return;
                    }
                    
                    const birthdays = Object.keys(data.data).length;
                    const currentMonth = new Date().getMonth() + 1;
                    const thisMonth = Object.values(data.data).filter(bd => bd.month === currentMonth).length;
                    
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">å·²ç™»è¨˜ç”Ÿæ—¥</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${birthdays}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">æœ¬æœˆå£½æ˜Ÿ</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${thisMonth}</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('birthday-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // è¼‰å…¥éŠæˆ²çµ±è¨ˆ
        async function loadGames() {
            try {
                const response = await fetch('/api/data/' + GUILD_ID + '/game_stats');
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('game-data');
                    
                    if (!data.exists || Object.keys(data.data).length === 0) {
                        container.innerHTML = '<p style="color: #888;">æš«ç„¡éŠæˆ²çµ±è¨ˆ</p>';
                        return;
                    }
                    
                    // è¨ˆç®—çµ±è¨ˆ
                    const players = Object.keys(data.data).length;
                    let totalGames = 0;
                    let totalWins = 0;
                    const gameTypes = {};
                    
                    Object.values(data.data).forEach(player => {
                        totalGames += player.total_games || 0;
                        totalWins += player.total_wins || 0;
                        
                        if (player.games) {
                            Object.entries(player.games).forEach(([game, stats]) => {
                                if (!gameTypes[game]) {
                                    gameTypes[game] = { played: 0, won: 0 };
                                }
                                gameTypes[game].played += stats.played || 0;
                                gameTypes[game].won += stats.won || 0;
                            });
                        }
                    });
                    
                    const winRate = totalGames > 0 ? (totalWins / totalGames * 100) : 0;
                    
                    let gameTypesHtml = '';
                    Object.entries(gameTypes).forEach(([name, stats]) => {
                        const rate = stats.played > 0 ? (stats.won / stats.played * 100) : 0;
                        gameTypesHtml += `
                            <div style="background: #1a1a1a; padding: 0.75rem; border-left: 3px solid #2563eb; margin-bottom: 0.5rem;">
                                <div style="color: #2563eb; font-weight: 600;">${name}</div>
                                <div style="font-size: 0.85rem; color: #888;">
                                    ${stats.played} å ´éŠæˆ² | å‹ç‡ ${rate.toFixed(1)}%
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">éŠæˆ²ç©å®¶</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${players}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">ç¸½éŠæˆ²å ´æ¬¡</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${totalGames.toLocaleString()}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">å¹³å‡å‹ç‡</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${winRate.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="color: #888; font-size: 0.9rem; margin-bottom: 0.5rem;">å„éŠæˆ²çµ±è¨ˆ</div>
                            ${gameTypesHtml || '<p style="color: #888;">æš«ç„¡éŠæˆ²æ•¸æ“š</p>'}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('game-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // è¼‰å…¥ä¼ºæœå™¨çµ±è¨ˆ
        async function loadStatistics() {
            try {
                const response = await fetch('/api/data/' + GUILD_ID + '/statistics');
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('statistics-data');
                    
                    if (!data.exists) {
                        container.innerHTML = '<p style="color: #888;">æš«ç„¡æ´»èºåº¦æ•¸æ“š</p>';
                        return;
                    }
                    
                    const stats = data.data;
                    const totalMessages = stats.total_messages || 0;
                    
                    // è¨ˆç®—ä»Šæ—¥è¨Šæ¯
                    const today = new Date().toISOString().split('T')[0];
                    const todayMessages = stats.daily_messages?.[today] || 0;
                    
                    // æ‰¾å‡ºæœ€ç†±é–€é »é“
                    let topChannel = 'æš«ç„¡æ•¸æ“š';
                    let topChannelCount = 0;
                    if (stats.channel_stats) {
                        Object.entries(stats.channel_stats).forEach(([id, info]) => {
                            if (info.messages > topChannelCount) {
                                topChannelCount = info.messages;
                                topChannel = '#' + info.name;
                            }
                        });
                    }
                    
                    // æ‰¾å‡ºæœ€æ´»èºæ™‚æ®µ
                    let peakHour = 'æš«ç„¡æ•¸æ“š';
                    let peakCount = 0;
                    if (stats.hourly_activity) {
                        Object.entries(stats.hourly_activity).forEach(([hour, count]) => {
                            if (count > peakCount) {
                                peakCount = count;
                                peakHour = hour + ':00';
                            }
                        });
                    }
                    
                    // æ´»èºç”¨æˆ¶æ•¸
                    const activeUsers = Object.keys(stats.user_stats || {}).length;
                    
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">ç¸½è¨Šæ¯æ•¸</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${totalMessages.toLocaleString()}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">ä»Šæ—¥è¨Šæ¯</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${todayMessages.toLocaleString()}</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="color: #888; font-size: 0.9rem;">æ´»èºç”¨æˆ¶</div>
                                <div style="font-size: 1.5rem; color: #2563eb; font-weight: 600;">${activeUsers}</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div style="background: #1a1a1a; padding: 1rem;">
                                <div style="color: #888; font-size: 0.9rem; margin-bottom: 0.5rem;">æœ€ç†±é–€é »é“</div>
                                <div style="color: #2563eb; font-weight: 600;">${topChannel}</div>
                                <div style="color: #888; font-size: 0.85rem;">${topChannelCount.toLocaleString()} æ¢è¨Šæ¯</div>
                            </div>
                            <div style="background: #1a1a1a; padding: 1rem;">
                                <div style="color: #888; font-size: 0.9rem; margin-bottom: 0.5rem;">æœ€æ´»èºæ™‚æ®µ</div>
                                <div style="color: #2563eb; font-weight: 600;">${peakHour}</div>
                                <div style="color: #888; font-size: 0.85rem;">${peakCount.toLocaleString()} æ¢è¨Šæ¯</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('statistics-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // è¼‰å…¥è‡ªå®šç¾©å‘½ä»¤
        async function loadCustomCommands() {
            try {
                const response = await fetch('/api/custom-commands/' + GUILD_ID);
                const data = await response.json();
                const container = document.getElementById('custom-commands-data');
                
                if (!data.commands || Object.keys(data.commands).length === 0) {
                    container.innerHTML = `
                        <p style="color: #888;">å°šæœªè¨­å®šä»»ä½•è‡ªå®šç¾©å‘½ä»¤</p>
                        <button onclick="showAddCommandModal()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; cursor: pointer;">æ·»åŠ å‘½ä»¤</button>
                    `;
                } else {
                    let html = `
                        <button onclick="showAddCommandModal()" style="margin-bottom: 1rem; padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; cursor: pointer;">æ·»åŠ å‘½ä»¤</button>
                        <div style="display: grid; gap: 0.75rem;">
                    `;
                    
                    for (const [name, cmd] of Object.entries(data.commands)) {
                        html += `
                            <div style="background: #1a1a1a; padding: 1rem; border-left: 3px solid #2563eb;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="color: #2563eb; font-weight: 600; font-size: 1.1rem;">!${name}</div>
                                        <div style="color: #ccc; margin-top: 0.5rem;">${cmd.response}</div>
                                        <div style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">ä½¿ç”¨æ¬¡æ•¸ï¼š${cmd.uses || 0}</div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button onclick="editCommand('${name}', '${cmd.response.replace(/'/g, "&apos;")}')" style="padding: 0.25rem 0.75rem; background: #333; color: #2563eb; border: 1px solid #2563eb; cursor: pointer;">ç·¨è¼¯</button>
                                        <button onclick="deleteCommand('${name}')" style="padding: 0.25rem 0.75rem; background: #333; color: #dc2626; border: 1px solid #dc2626; cursor: pointer;">åˆªé™¤</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    container.innerHTML = html;
                }
            } catch (error) {
                document.getElementById('custom-commands-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // é¡¯ç¤ºæ·»åŠ å‘½ä»¤æ¨¡æ…‹æ¡†
        function showAddCommandModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: #2b2b2b; padding: 2rem; width: 90%; max-width: 500px; border: 1px solid #333;">
                    <h3 style="margin-top: 0; color: #fff;">æ·»åŠ è‡ªå®šç¾©å‘½ä»¤</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="color: #ccc; display: block; margin-bottom: 0.5rem;">å‘½ä»¤åç¨±ï¼ˆä¸åŒ…å«!ï¼‰</label>
                        <input id="cmd-name" type="text" style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid #333; color: #fff;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="color: #ccc; display: block; margin-bottom: 0.5rem;">å›è¦†å…§å®¹</label>
                        <textarea id="cmd-response" rows="4" style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid #333; color: #fff;"></textarea>
                    </div>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 0.5rem 1rem; background: #333; color: #ccc; border: 1px solid #444; cursor: pointer;">å–æ¶ˆ</button>
                        <button onclick="addCommand()" style="padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; cursor: pointer;">ç¢ºå®š</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // æ·»åŠ å‘½ä»¤
        async function addCommand() {
            const name = document.getElementById('cmd-name').value.trim();
            const response = document.getElementById('cmd-response').value.trim();
            
            if (!name || !response) {
                showNotification('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/custom-commands/' + GUILD_ID, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, response })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showNotification('å‘½ä»¤å·²æ·»åŠ ï¼', 'success');
                    loadCustomCommands();
                    document.querySelector('div[style*="fixed"]').remove();
                } else {
                    showNotification(data.error || 'æ·»åŠ å¤±æ•—', 'error');
                }
            } catch (error) {
                showNotification('æ·»åŠ å¤±æ•—', 'error');
            }
        }

        // ç·¨è¼¯å‘½ä»¤
        function editCommand(name, currentResponse) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: #2b2b2b; padding: 2rem; width: 90%; max-width: 500px; border: 1px solid #333;">
                    <h3 style="margin-top: 0; color: #fff;">ç·¨è¼¯å‘½ä»¤ï¼š!${name}</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="color: #ccc; display: block; margin-bottom: 0.5rem;">å›è¦†å…§å®¹</label>
                        <textarea id="edit-response" rows="4" style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid #333; color: #fff;">${currentResponse.replace(/&apos;/g, "'")}</textarea>
                    </div>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding: 0.5rem 1rem; background: #333; color: #ccc; border: 1px solid #444; cursor: pointer;">å–æ¶ˆ</button>
                        <button onclick="saveEditCommand('${name}')" style="padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; cursor: pointer;">å„²å­˜</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // å„²å­˜ç·¨è¼¯
        async function saveEditCommand(name) {
            const response = document.getElementById('edit-response').value.trim();
            
            if (!response) {
                showNotification('è«‹å¡«å¯«å›è¦†å…§å®¹', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/custom-commands/' + GUILD_ID + '/' + encodeURIComponent(name), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ response })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showNotification('å‘½ä»¤å·²æ›´æ–°ï¼', 'success');
                    loadCustomCommands();
                    document.querySelector('div[style*="fixed"]').remove();
                } else {
                    showNotification(data.error || 'æ›´æ–°å¤±æ•—', 'error');
                }
            } catch (error) {
                showNotification('æ›´æ–°å¤±æ•—', 'error');
            }
        }

        // åˆªé™¤å‘½ä»¤
        async function deleteCommand(name) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å‘½ä»¤ !${name} å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const res = await fetch('/api/custom-commands/' + GUILD_ID + '/' + encodeURIComponent(name), {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showNotification('å‘½ä»¤å·²åˆªé™¤ï¼', 'success');
                    loadCustomCommands();
                } else {
                    showNotification(data.error || 'åˆªé™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                showNotification('åˆªé™¤å¤±æ•—', 'error');
            }
        }

        // è¼‰å…¥è‡¨æ™‚èªéŸ³é…ç½®
        async function loadTempVoice() {
            try {
                const [configRes, channelsRes] = await Promise.all([
                    fetch('/api/temp-voice/' + GUILD_ID),
                    fetch('/api/channels/' + GUILD_ID)
                ]);
                
                const configData = await configRes.json();
                const channelsData = await channelsRes.json();
                
                const container = document.getElementById('temp-voice-data');
                const config = configData.config;
                
                let html = `
                    <div style="background: #1a1a1a; padding: 1.25rem; border-left: 3px solid ${config.enabled ? '#2563eb' : '#666'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="color: #ccc; font-weight: 600;">ç³»çµ±ç‹€æ…‹</div>
                            <label style="position: relative; display: inline-block; width: 44px; height: 22px;">
                                <input type="checkbox" ${config.enabled ? 'checked' : ''} onchange="toggleTempVoice(this.checked)" style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ${config.enabled ? '#333' : '#2b2b2b'}; transition: 0.3s; border: 1px solid ${config.enabled ? '#2563eb' : '#444'};">
                                    <span style="position: absolute; content: ''; height: 14px; width: 14px; left: 3px; bottom: 3px; background: ${config.enabled ? '#2563eb' : '#666'}; transition: 0.3s; transform: translateX(${config.enabled ? '22px' : '0'});"></span>
                                </span>
                            </label>
                        </div>
                        
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="color: #666; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">è§¸ç™¼é »é“</label>
                                <select id="trigger-channel" onchange="updateTempVoiceConfig()" style="width: 100%; padding: 0.5rem; background: #2b2b2b; border: 1px solid #333; color: #ccc;">
                                    <option value="">é¸æ“‡èªéŸ³é »é“...</option>
                                    ${channelsData.voice_channels.map(ch => 
                                        '<option value="' + ch.id + '" ' + (config.trigger_channel_id == ch.id ? 'selected' : '') + '>' + ch.name + '</option>'
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label style="color: #666; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">é »é“åˆ†é¡ï¼ˆå¯é¸ï¼‰</label>
                                <select id="category" onchange="updateTempVoiceConfig()" style="width: 100%; padding: 0.5rem; background: #2b2b2b; border: 1px solid #333; color: #ccc;">
                                    <option value="">ç„¡åˆ†é¡</option>
                                    ${channelsData.categories.map(cat => 
                                        '<option value="' + cat.id + '" ' + (config.category_id == cat.id ? 'selected' : '') + '>' + cat.name + '</option>'
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label style="color: #666; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">é »é“åç¨±æ ¼å¼</label>
                                <input id="channel-format" type="text" value="${config.channel_name_format}" onchange="updateTempVoiceConfig()" style="width: 100%; padding: 0.5rem; background: #2b2b2b; border: 1px solid #333; color: #ccc;">
                                <div style="color: #555; font-size: 0.85rem; margin-top: 0.25rem;">ä½¿ç”¨ {username} ä»£è¡¨ç”¨æˆ¶å</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 1rem; background: #2b2b2b; border-left: 3px solid #2563eb;">
                            <div style="color: #888; font-size: 0.9rem;">ä½¿ç”¨èªªæ˜ï¼š</div>
                            <div style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">
                                1. é¸æ“‡ä¸€å€‹èªéŸ³é »é“ä½œç‚ºè§¸ç™¼å™¨<br>
                                2. ç”¨æˆ¶åŠ å…¥è©²é »é“æ™‚æœƒè‡ªå‹•å‰µå»ºè‡¨æ™‚é »é“<br>
                                3. æ‰€æœ‰æˆå“¡é›¢é–‹å¾Œè‡ªå‹•åˆªé™¤<br>
                                4. ç”¨æˆ¶å¯ä½¿ç”¨ /è‡¨æ™‚èªéŸ³ å‘½ä»¤ç®¡ç†è‡ªå·±çš„é »é“
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('temp-voice-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // åˆ‡æ›è‡¨æ™‚èªéŸ³ç³»çµ±
        async function toggleTempVoice(enabled) {
            try {
                const res = await fetch('/api/temp-voice/' + GUILD_ID, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showNotification(enabled ? 'è‡¨æ™‚èªéŸ³ç³»çµ±å·²å•Ÿç”¨' : 'è‡¨æ™‚èªéŸ³ç³»çµ±å·²åœç”¨', 'success');
                    loadTempVoice();
                } else {
                    showNotification(data.error || 'æ›´æ–°å¤±æ•—', 'error');
                    loadTempVoice();
                }
            } catch (error) {
                showNotification('æ›´æ–°å¤±æ•—', 'error');
                loadTempVoice();
            }
        }

        // æ›´æ–°è‡¨æ™‚èªéŸ³é…ç½®
        async function updateTempVoiceConfig() {
            const triggerChannel = document.getElementById('trigger-channel').value || null;
            const category = document.getElementById('category').value || null;
            const channelFormat = document.getElementById('channel-format').value;
            
            try {
                const res = await fetch('/api/temp-voice/' + GUILD_ID, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        trigger_channel_id: triggerChannel,
                        category_id: category,
                        channel_name_format: channelFormat
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showNotification('é…ç½®å·²æ›´æ–°ï¼', 'success');
                } else {
                    showNotification(data.error || 'æ›´æ–°å¤±æ•—', 'error');
                }
            } catch (error) {
                showNotification('æ›´æ–°å¤±æ•—', 'error');
            }
        }

        // ===== å®¢æœå–®ç³»çµ±ç®¡ç† =====
        async function loadTickets() {
            try {
                const [ticketsRes, channelsRes, rolesRes] = await Promise.all([
                    fetch('/api/tickets/' + GUILD_ID),
                    fetch('/api/channels/' + GUILD_ID),
                    fetch('/api/stats/' + GUILD_ID)
                ]);
                
                const ticketsData = await ticketsRes.json();
                const channelsData = await channelsRes.json();
                const statsData = await rolesRes.json();
                
                const container = document.getElementById('tickets-data');
                const config = ticketsData.exists ? ticketsData.data : {
                    enabled: false,
                    category_id: null,
                    support_role_id: null,
                    log_channel_id: null,
                    tickets: {},
                    ticket_count: 0
                };
                
                // çµ±è¨ˆé–‹å•Ÿå’Œé—œé–‰çš„å®¢æœå–®æ•¸é‡
                const openTickets = Object.values(config.tickets).filter(t => t.status === 'open');
                const closedTickets = Object.values(config.tickets).filter(t => t.status === 'closed');
                
                let html = `
                    <!-- ç³»çµ±ç‹€æ…‹ -->
                    <div style="background: #1a1a1a; padding: 1.25rem; border-left: 3px solid ` + (config.enabled ? '#2563eb' : '#666') + `; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div style="color: #ccc; font-weight: 600;">ç³»çµ±ç‹€æ…‹</div>
                            <label style="position: relative; display: inline-block; width: 44px; height: 22px;">
                                <input type="checkbox" ` + (config.enabled ? 'checked' : '') + ` onchange="toggleTickets(this.checked)" style="opacity: 0; width: 0; height: 0;">
                                <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: ` + (config.enabled ? '#333' : '#2b2b2b') + `; transition: 0.3s; border: 1px solid ` + (config.enabled ? '#2563eb' : '#444') + `;">
                                    <span style="position: absolute; content: ''; height: 14px; width: 14px; left: 3px; bottom: 3px; background: ` + (config.enabled ? '#2563eb' : '#666') + `; transition: 0.3s; transform: translateX(` + (config.enabled ? '22px' : '0') + `);"></span>
                                </span>
                            </label>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 1rem;">
                            <div style="background: #2b2b2b; padding: 1rem; text-align: center;">
                                <div style="color: #2563eb; font-size: 1.75rem; font-weight: 600;">${openTickets.length}</div>
                                <div style="color: #888; font-size: 0.85rem;">é–‹å•Ÿä¸­</div>
                            </div>
                            <div style="background: #2b2b2b; padding: 1rem; text-align: center;">
                                <div style="color: #10b981; font-size: 1.75rem; font-weight: 600;">${closedTickets.length}</div>
                                <div style="color: #888; font-size: 0.85rem;">å·²é—œé–‰</div>
                            </div>
                            <div style="background: #2b2b2b; padding: 1rem; text-align: center;">
                                <div style="color: #f59e0b; font-size: 1.75rem; font-weight: 600;">${config.ticket_count}</div>
                                <div style="color: #888; font-size: 0.85rem;">ç¸½è¨ˆ</div>
                            </div>
                        </div>
                    </div>

                    <!-- ç³»çµ±è¨­å®š -->
                    <div style="background: #1a1a1a; padding: 1.25rem; border-left: 3px solid #2563eb; margin-bottom: 1.5rem;">
                        <div style="color: #fff; font-weight: 600; margin-bottom: 1rem;">ç³»çµ±è¨­å®š</div>
                        
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label style="color: #666; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">å®¢æœå–®åˆ†é¡</label>
                                <select id="ticket-category" onchange="updateTicketSettings()" style="width: 100%; padding: 0.5rem; background: #2b2b2b; border: 1px solid #333; color: #ccc;">
                                    <option value="">è«‹é¸æ“‡åˆ†é¡...</option>
                                    ${(channelsData.categories || []).map(cat => 
                                        '<option value="' + cat.id + '" ' + (config.category_id == cat.id ? 'selected' : '') + '>' + cat.name + '</option>'
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label style="color: #666; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">æ”¯æŒåœ˜éšŠè§’è‰²</label>
                                <select id="ticket-support-role" onchange="updateTicketSettings()" style="width: 100%; padding: 0.5rem; background: #2b2b2b; border: 1px solid #333; color: #ccc;">
                                    <option value="">ç„¡</option>
                                    ${Object.values(statsData.roles || {}).map(role => 
                                        '<option value="' + role.id + '" ' + (config.support_role_id == role.id ? 'selected' : '') + '>' + role.name + '</option>'
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label style="color: #666; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">æ—¥èªŒé »é“</label>
                                <select id="ticket-log-channel" onchange="updateTicketSettings()" style="width: 100%; padding: 0.5rem; background: #2b2b2b; border: 1px solid #333; color: #ccc;">
                                    <option value="">ç„¡</option>
                                    ${(channelsData.text_channels || []).map(ch => 
                                        '<option value="' + ch.id + '" ' + (config.log_channel_id == ch.id ? 'selected' : '') + '>' + ch.name + '</option>'
                                    ).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label style="color: #666; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">é¢æ¿é »é“ï¼ˆé¸æ“‡å¾Œå¯å‰µå»ºé¢æ¿ï¼‰</label>
                                <select id="ticket-panel-channel" onchange="updateTicketSettings()" style="width: 100%; padding: 0.5rem; background: #2b2b2b; border: 1px solid #333; color: #ccc;">
                                    <option value="">ç„¡</option>
                                    ${(channelsData.text_channels || []).map(ch => 
                                        '<option value="' + ch.id + '" ' + (config.panel_channel_id == ch.id ? 'selected' : '') + '>' + ch.name + '</option>'
                                    ).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <button onclick="createTicketPanel()" ` + (!config.panel_channel_id ? 'disabled' : '') + ` style="width: 100%; padding: 0.75rem; background: ` + (config.panel_channel_id ? '#2563eb' : '#444') + `; border: none; color: ` + (config.panel_channel_id ? 'white' : '#666') + `; cursor: ` + (config.panel_channel_id ? 'pointer' : 'not-allowed') + `; font-weight: 600; transition: all 0.2s;">
                                ğŸ« å‰µå»ºå®¢æœå–®é¢æ¿
                            </button>
                            ` + (!config.panel_channel_id ? '<div style="color: #888; font-size: 0.85rem; text-align: center; margin-top: 0.5rem;">è«‹å…ˆé¸æ“‡é¢æ¿é »é“</div>' : '') + `
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 1rem; background: #2b2b2b; border-left: 3px solid #2563eb;">
                            <div style="color: #888; font-size: 0.9rem;">ä½¿ç”¨èªªæ˜ï¼š</div>
                            <div style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">
                                1. é¸æ“‡å®¢æœå–®é »é“åˆ†é¡<br>
                                2. é¸æ“‡æ”¯æŒåœ˜éšŠè§’è‰²ï¼ˆå¯é¸ï¼‰<br>
                                3. è¨­å®šæ—¥èªŒé »é“è¨˜éŒ„å®¢æœå–®æ“ä½œ<br>
                                4. é¸æ“‡é¢æ¿é »é“å¾Œé»æ“Šå‰µå»ºé¢æ¿æŒ‰éˆ•
                            </div>
                        </div>
                    </div>

                    <!-- é–‹å•Ÿä¸­çš„å®¢æœå–® -->
                    <div style="background: #1a1a1a; padding: 1.25rem; border-left: 3px solid #10b981; margin-bottom: 1.5rem;">
                        <div style="color: #fff; font-weight: 600; margin-bottom: 1rem;">é–‹å•Ÿä¸­çš„å®¢æœå–® (${openTickets.length})</div>
                        
                        ${openTickets.length > 0 ? `
                            <div style="display: grid; gap: 0.75rem;">
                                ${openTickets.map((ticket, idx) => {
                                    const ticketId = Object.keys(config.tickets).find(k => config.tickets[k] === ticket);
                                    const userName = ticket.user_name || 'æœªçŸ¥';
                                    const createdTime = new Date(ticket.created_at).toLocaleString('zh-TW');
                                    return `
                                        <div style="background: #2b2b2b; padding: 1rem; border-left: 3px solid #2563eb;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                                <div>
                                                    <div style="color: #fff; font-weight: 600;">å®¢æœå–® #` + ticketId + `</div>
                                                    <div style="color: #888; font-size: 0.85rem; margin-top: 0.25rem;">
                                                        å‰µå»ºè€…: ` + userName + `
                                                    </div>
                                                </div>
                                                <div style="padding: 0.5rem 1rem; background: #374151; color: #9ca3af; font-size: 0.85rem; border-radius: 4px; font-weight: 600;">
                                                    ğŸ”’ è«‹åœ¨ Discord å…§é—œé–‰
                                                </div>
                                            </div>
                                            <div style="color: #666; font-size: 0.85rem;">
                                                å‰µå»ºæ™‚é–“: ` + createdTime + `
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : '<div style="color: #666; text-align: center; padding: 2rem;">ç›®å‰æ²’æœ‰é–‹å•Ÿçš„å®¢æœå–®</div>'}
                    </div>

                    <!-- æœ€è¿‘é—œé–‰çš„å®¢æœå–® -->
                    <div style="background: #1a1a1a; padding: 1.25rem; border-left: 3px solid #6b7280;">
                        <div style="color: #fff; font-weight: 600; margin-bottom: 1rem;">æœ€è¿‘é—œé–‰çš„å®¢æœå–®</div>
                        
                        ${closedTickets.length > 0 ? `
                            <div style="display: grid; gap: 0.75rem;">
                                ${closedTickets.slice(-10).reverse().map((ticket, idx) => {
                                    const ticketId = Object.keys(config.tickets).find(k => config.tickets[k] === ticket);
                                    const userName = ticket.user_name || 'æœªçŸ¥';
                                    const closerName = ticket.closer_name || ticket.closed_by || 'æœªçŸ¥';
                                    const closedTime = new Date(ticket.closed_at).toLocaleString('zh-TW');
                                    const closeReason = ticket.close_reason || '';
                                    return `
                                        <div style="background: #2b2b2b; padding: 1rem; border-left: 3px solid #6b7280;">
                                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                                <div>
                                                    <div style="color: #fff; font-weight: 600;">å®¢æœå–® #` + ticketId + `</div>
                                                    <div style="color: #888; font-size: 0.85rem; margin-top: 0.25rem;">
                                                        å‰µå»ºè€…: ` + userName + `
                                                    </div>
                                                    <div style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">
                                                        é—œé–‰è€…: ` + closerName + `
                                                    </div>
                                                    ` + (closeReason ? `
                                                        <div style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">
                                                            åŸå› : ` + closeReason + `
                                                        </div>
                                                    ` : '') + `
                                                </div>
                                            </div>
                                            <div style="color: #666; font-size: 0.85rem; margin-top: 0.5rem;">
                                                é—œé–‰æ™‚é–“: ` + closedTime + `
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : '<div style="color: #666; text-align: center; padding: 2rem;">æ²’æœ‰é—œé–‰è¨˜éŒ„</div>'}
                    </div>
                `;
                
                container.innerHTML = html;
            } catch (error) {
                document.getElementById('tickets-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
                console.error('è¼‰å…¥å®¢æœå–®å¤±æ•—:', error);
            }
        }

        // åˆ‡æ›å®¢æœå–®ç³»çµ±
        async function toggleTickets(enabled) {
            try {
                const res = await fetch('/api/tickets/' + GUILD_ID + '/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showNotification(enabled ? 'å®¢æœå–®ç³»çµ±å·²å•Ÿç”¨' : 'å®¢æœå–®ç³»çµ±å·²åœç”¨', 'success');
                    loadTickets();
                } else {
                    showNotification(data.error || 'æ›´æ–°å¤±æ•—', 'error');
                    loadTickets();
                }
            } catch (error) {
                showNotification('æ›´æ–°å¤±æ•—', 'error');
                loadTickets();
            }
        }

        // æ›´æ–°å®¢æœå–®è¨­å®š
        async function updateTicketSettings() {
            const category = document.getElementById('ticket-category').value || null;
            const supportRole = document.getElementById('ticket-support-role').value || null;
            const logChannel = document.getElementById('ticket-log-channel').value || null;
            const panelChannel = document.getElementById('ticket-panel-channel').value || null;
            
            try {
                const res = await fetch('/api/tickets/' + GUILD_ID + '/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category_id: category,
                        support_role_id: supportRole,
                        log_channel_id: logChannel,
                        panel_channel_id: panelChannel
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showNotification('è¨­å®šå·²æ›´æ–°ï¼', 'success');
                    loadTickets(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°å‰µå»ºé¢æ¿æŒ‰éˆ•ç‹€æ…‹
                } else {
                    showNotification(data.error || 'æ›´æ–°å¤±æ•—', 'error');
                }
            } catch (error) {
                showNotification('æ›´æ–°å¤±æ•—', 'error');
            }
        }

        // å‰µå»ºå®¢æœå–®é¢æ¿
        async function createTicketPanel() {
            const panelChannel = document.getElementById('ticket-panel-channel').value;
            
            if (!panelChannel) {
                showNotification('è«‹å…ˆé¸æ“‡é¢æ¿é »é“', 'error');
                return;
            }
            
            if (!confirm('ç¢ºå®šè¦åœ¨é¸å®šçš„é »é“å‰µå»ºå®¢æœå–®é¢æ¿å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/tickets/${GUILD_ID}/create-panel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channel_id: panelChannel })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showNotification('âœ… å®¢æœå–®é¢æ¿å·²å‰µå»ºï¼', 'success');
                    loadTickets();
                } else {
                    showNotification(data.error || 'å‰µå»ºå¤±æ•—', 'error');
                }
            } catch (error) {
                showNotification('å‰µå»ºå¤±æ•—', 'error');
                console.error('å‰µå»ºé¢æ¿å¤±æ•—:', error);
            }
        }

        // é—œé–‰å®¢æœå–®ï¼ˆå·²ç¦ç”¨ï¼‰
        async function closeTicket(ticketId) {
            showNotification('ç¶²é å¾Œå°ä¸æ”¯æ´é—œé–‰å®¢æœå–®ï¼Œè«‹åœ¨ Discord å…§ä½¿ç”¨é—œé–‰æŒ‰éˆ•', 'error');
        }

        // ===== è­¦å‘Šç³»çµ±ç®¡ç† =====
        async function loadWarnings() {
            try {
                const response = await fetch('/api/warnings/' + GUILD_ID);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('warnings-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
                    return;
                }
                
                const warnings = data.warnings;
                const userCount = Object.keys(warnings).length;
                
                if (userCount === 0) {
                    document.getElementById('warnings-data').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #888;">
                            <p>âœ… ç›®å‰æ²’æœ‰ä»»ä½•è­¦å‘Šè¨˜éŒ„</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div style="margin-bottom: 1rem; color: #888;">
                        å…±æœ‰ ${userCount} ä½ç”¨æˆ¶æœ‰è­¦å‘Šè¨˜éŒ„
                    </div>
                    <div style="max-height: 600px; overflow-y: auto;">
                `;
                
                // æŒ‰è­¦å‘Šæ¬¡æ•¸æ’åº
                const sortedUsers = Object.entries(warnings).sort((a, b) => b[1].warn_count - a[1].warn_count);
                
                for (const [userId, userData] of sortedUsers) {
                    const warnCount = userData.warn_count;
                    const warnColor = warnCount >= 5 ? '#dc2626' : warnCount >= 3 ? '#f59e0b' : '#eab308';
                    
                    html += `
                        <div style="background: #1a1a1a; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid ${warnColor};">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    ${userData.avatar ? `<img src="${userData.avatar}" style="width: 40px; height: 40px; border-radius: 50%;">` : ''}
                                    <div>
                                        <div style="font-weight: 600; color: #fff;">${userData.display_name || userData.username}</div>
                                        <div style="color: #888; font-size: 0.9rem;">è­¦å‘Šæ¬¡æ•¸: <span style="color: ${warnColor}; font-weight: 600;">${warnCount}</span></div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="removeLatestWarning('${userId}')" class="btn btn-warning" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                        ç§»é™¤æœ€æ–°
                                    </button>
                                    <button onclick="clearWarnings('${userId}')" class="btn btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                                        æ¸…é™¤å…¨éƒ¨
                                    </button>
                                </div>
                            </div>
                            <div style="margin-top: 0.5rem; border-top: 1px solid #333; padding-top: 0.5rem;">
                    `;
                    
                    // é¡¯ç¤ºæœ€è¿‘5æ¢è­¦å‘Š
                    const recentWarnings = userData.warnings.slice(-5).reverse();
                    for (let i = 0; i < recentWarnings.length; i++) {
                        const warn = recentWarnings[i];
                        const actualIndex = userData.warnings.length - 1 - i;
                        const timestamp = new Date(warn.timestamp).toLocaleString('zh-TW');
                        html += `
                            <div style="padding: 0.5rem; background: #2b2b2b; margin-bottom: 0.3rem; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="color: #eab308;">ç†ç”±: ${warn.reason}</div>
                                    <div style="color: #888; font-size: 0.85rem;">æ“ä½œè€…: ${warn.moderator_name} | ${timestamp}</div>
                                </div>
                                <button onclick="removeWarning('${userId}', ${actualIndex})" class="btn btn-sm" style="padding: 0.3rem 0.6rem; font-size: 0.8rem; background: #dc2626; color: white; border: none; cursor: pointer;">
                                    ç§»é™¤ç•¶å‰
                                </button>
                            </div>
                        `;
                    }
                    
                    if (userData.warnings.length > 5) {
                        html += `<div style="color: #888; text-align: center; font-size: 0.85rem;">é‚„æœ‰ ${userData.warnings.length - 5} æ¢æ­·å²è¨˜éŒ„...</div>`;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                document.getElementById('warnings-data').innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥è­¦å‘Šæ•¸æ“šå¤±æ•—:', error);
                document.getElementById('warnings-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        async function removeLatestWarning(userId) {
            if (!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤ç”¨æˆ¶çš„æœ€æ–°è­¦å‘Šå—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/warnings/${GUILD_ID}/${userId}/latest`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    showNotification(data.message || 'å·²ç§»é™¤è­¦å‘Š', 'success');
                    loadWarnings();
                } else {
                    showNotification(data.message || data.error || 'æ“ä½œå¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('ç§»é™¤è­¦å‘Šå¤±æ•—:', error);
                showNotification('æ“ä½œå¤±æ•—', 'error');
            }
        }

        async function clearWarnings(userId) {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ­¤ç”¨æˆ¶çš„æ‰€æœ‰è­¦å‘Šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼')) return;
            
            try {
                const res = await fetch(`/api/warnings/${GUILD_ID}/${userId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    showNotification(data.message || 'å·²æ¸…é™¤è­¦å‘Š', 'success');
                    loadWarnings();
                } else {
                    showNotification(data.message || data.error || 'æ“ä½œå¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('æ¸…é™¤è­¦å‘Šå¤±æ•—:', error);
                showNotification('æ“ä½œå¤±æ•—', 'error');
            }
        }

        async function removeWarning(userId, index) {
            if (!confirm('ç¢ºå®šè¦ç§»é™¤æ­¤è­¦å‘Šå—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/warnings/${GUILD_ID}/${userId}/${index}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    showNotification(data.message || 'å·²ç§»é™¤è­¦å‘Š', 'success');
                    loadWarnings();
                } else {
                    showNotification(data.message || data.error || 'æ“ä½œå¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('ç§»é™¤è­¦å‘Šå¤±æ•—:', error);
                showNotification('æ“ä½œå¤±æ•—', 'error');
            }
        }

        // ===== æˆå°±ç³»çµ±ç®¡ç† =====
        async function loadAchievements() {
            try {
                const response = await fetch('/api/achievements/' + GUILD_ID);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('achievements-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
                    return;
                }
                
                const achievements = data.achievements;
                const userCount = Object.keys(achievements).length;
                
                if (userCount === 0) {
                    document.getElementById('achievements-data').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #888;">
                            <p>ç›®å‰æ²’æœ‰ç”¨æˆ¶è§£é–æˆå°±</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div style="margin-bottom: 1rem; color: #888;">
                        å…±æœ‰ ${userCount} ä½ç”¨æˆ¶è§£é–äº†æˆå°±
                    </div>
                    <div style="max-height: 600px; overflow-y: auto;">
                `;
                
                // æŒ‰æˆå°±æ•¸é‡æ’åº
                const sortedUsers = Object.entries(achievements).sort((a, b) => b[1].achievement_count - a[1].achievement_count);
                
                for (const [userId, userData] of sortedUsers) {
                    const achievementCount = userData.achievement_count;
                    
                    html += `
                        <div style="background: #1a1a1a; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; border-left: 4px solid #2563eb;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                ${userData.avatar ? `<img src="${userData.avatar}" style="width: 40px; height: 40px; border-radius: 50%;">` : ''}
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #fff;">${userData.display_name || userData.username}</div>
                                    <div style="color: #2563eb; font-size: 0.9rem;">ğŸ† å·²è§£é– ${achievementCount} å€‹æˆå°±</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                    `;
                    
                    // é¡¯ç¤ºæˆå°±
                    for (const ach of userData.achievements) {
                        const rarityColors = {
                            'æ™®é€š': '#888',
                            'ç¨€æœ‰': '#3b82f6',
                            'å²è©©': '#a855f7',
                            'å‚³å¥‡': '#eab308'
                        };
                        const rarityColor = rarityColors[ach.rarity] || '#888';
                        
                        html += `
                            <div style="background: #2b2b2b; padding: 0.5rem; border-radius: 4px; border-left: 3px solid ${rarityColor};">
                                <div style="font-size: 0.9rem; font-weight: 600; color: ${rarityColor};">${ach.name}</div>
                                <div style="font-size: 0.75rem; color: #888;">${ach.category}</div>
                            </div>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                document.getElementById('achievements-data').innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥æˆå°±æ•¸æ“šå¤±æ•—:', error);
                document.getElementById('achievements-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // ===== è‡ªå‹•å›è¦†ç³»çµ±ç®¡ç† =====
        async function loadAutoReply() {
            try {
                const response = await fetch('/api/auto-reply/' + GUILD_ID);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('auto-reply-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
                    return;
                }
                
                // æ›´æ–°ç³»çµ±ç‹€æ…‹é–‹é—œ
                const systemToggle = document.getElementById('auto-reply-system-toggle');
                const systemStatus = document.getElementById('auto-reply-system-status');
                systemToggle.checked = data.enabled !== false;
                systemStatus.textContent = data.enabled !== false ? 'ğŸŸ¢ å·²å•Ÿç”¨' : 'ğŸ”´ å·²åœç”¨';
                systemStatus.style.color = data.enabled !== false ? '#10b981' : '#888';
                
                const rules = data.rules || [];
                
                if (rules.length === 0) {
                    document.getElementById('auto-reply-data').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #888;">
                            <p>ğŸ“ ç›®å‰æ²’æœ‰ä»»ä½•è‡ªå‹•å›è¦†è¦å‰‡</p>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem;">é»æ“Šä¸Šæ–¹ã€Œæ·»åŠ è¦å‰‡ã€æŒ‰éˆ•é–‹å§‹å‰µå»º</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div style="margin-bottom: 1rem; color: #888;">
                        å…±æœ‰ ${rules.length} æ¢è¦å‰‡
                    </div>
                    <div style="display: grid; gap: 1rem;">
                `;
                
                for (const rule of rules) {
                    const statusColor = rule.enabled ? '#10b981' : '#888';
                    const statusIcon = rule.enabled ? 'ğŸŸ¢' : 'ğŸ”´';
                    const matchTypeLabels = {
                        'exact': 'å®Œå…¨åŒ¹é…',
                        'contains': 'åŒ…å«é—œéµè©',
                        'starts_with': 'ä»¥...é–‹é ­',
                        'ends_with': 'ä»¥...çµå°¾',
                        'regex': 'æ­£å‰‡è¡¨é”å¼'
                    };
                    const replyTypeLabels = {
                        'message': 'æ™®é€šæ¶ˆæ¯',
                        'reply': 'å›è¦†æ¶ˆæ¯',
                        'dm': 'ç§è¨Šç”¨æˆ¶',
                        'react': 'æ·»åŠ åæ‡‰'
                    };
                    
                    html += `
                        <div style="background: #1a1a1a; padding: 1.25rem; border-left: 4px solid ${statusColor}; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #fff; font-size: 1.1rem; margin-bottom: 0.5rem;">
                                        ${statusIcon} è¦å‰‡ #${rule.id}
                                        ${rule.trigger_once ? '<span style="background: #2563eb; color: white; font-size: 0.75rem; padding: 0.2rem 0.5rem; border-radius: 3px; margin-left: 0.5rem;">åƒ…è§¸ç™¼ä¸€æ¬¡</span>' : ''}
                                    </div>
                                    <div style="color: #888; font-size: 0.85rem;">
                                        å‰µå»ºæ–¼: ${new Date(rule.created_at).toLocaleString('zh-TW')}
                                        ${rule.last_triggered ? ' | æœ€å¾Œè§¸ç™¼: ' + new Date(rule.last_triggered).toLocaleString('zh-TW') : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="editAutoReplyRule(${rule.id})" 
                                            style="padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                        ç·¨è¼¯
                                    </button>
                                    <button onclick="toggleAutoReplyRule(${rule.id}, ${!rule.enabled})" 
                                            style="padding: 0.5rem 1rem; background: ${rule.enabled ? '#f59e0b' : '#10b981'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                        ${rule.enabled ? 'åœç”¨' : 'å•Ÿç”¨'}
                                    </button>
                                    <button onclick="deleteAutoReplyRule(${rule.id})" 
                                            style="padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                        åˆªé™¤
                                    </button>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: #2b2b2b; padding: 0.75rem; border-radius: 4px;">
                                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.25rem;">è§¸ç™¼è©</div>
                                    <div style="color: #fff; font-family: monospace;">${rule.trigger}</div>
                                </div>
                                <div style="background: #2b2b2b; padding: 0.75rem; border-radius: 4px;">
                                    <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.25rem;">è§¸ç™¼æ¬¡æ•¸</div>
                                    <div style="color: #2563eb; font-weight: 600; font-size: 1.2rem;">${rule.triggered_count || 0} æ¬¡</div>
                                </div>
                            </div>
                            
                            <div style="background: #2b2b2b; padding: 0.75rem; border-radius: 4px; margin-bottom: 1rem;">
                                <div style="color: #888; font-size: 0.85rem; margin-bottom: 0.25rem;">å›è¦†å…§å®¹</div>
                                <div style="color: #fff;">${rule.reply_type === 'react' ? 'åæ‡‰: ' + rule.reaction : rule.reply}</div>
                            </div>
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.85rem;">
                                <span style="background: #2b2b2b; color: #888; padding: 0.25rem 0.75rem; border-radius: 3px;">
                                    åŒ¹é…: ${matchTypeLabels[rule.match_type] || rule.match_type}
                                </span>
                                <span style="background: #2b2b2b; color: #888; padding: 0.25rem 0.75rem; border-radius: 3px;">
                                    å›è¦†: ${replyTypeLabels[rule.reply_type] || rule.reply_type}
                                </span>
                                ${rule.case_sensitive ? '<span style="background: #2563eb; color: white; padding: 0.25rem 0.75rem; border-radius: 3px;">å€åˆ†å¤§å°å¯«</span>' : ''}
                                ${rule.mention_user ? '<span style="background: #2563eb; color: white; padding: 0.25rem 0.75rem; border-radius: 3px;">æåŠç”¨æˆ¶</span>' : ''}
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                document.getElementById('auto-reply-data').innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥è‡ªå‹•å›è¦†æ•¸æ“šå¤±æ•—:', error);
                document.getElementById('auto-reply-data').innerHTML = '<p style="color: #dc2626;">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        // é–‹é—œè‡ªå‹•å›è¦†ç³»çµ±
        async function toggleAutoReplySystem(enabled) {
            try {
                const res = await fetch(`/api/auto-reply/${GUILD_ID}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                const data = await res.json();
                
                if (data.success) {
                    showNotification(enabled ? 'âœ… å·²å•Ÿç”¨è‡ªå‹•å›è¦†ç³»çµ±' : 'â¸ï¸ å·²åœç”¨è‡ªå‹•å›è¦†ç³»çµ±', 'success');
                    loadAutoReply();
                } else {
                    showNotification(data.error || 'æ“ä½œå¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('åˆ‡æ›ç³»çµ±å¤±æ•—:', error);
                showNotification('æ“ä½œå¤±æ•—', 'error');
            }
        }

        // é–‹é—œç‰¹å®šè¦å‰‡
        async function toggleAutoReplyRule(ruleId, enabled) {
            try {
                const res = await fetch(`/api/auto-reply/${GUILD_ID}/${ruleId}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                const data = await res.json();
                
                if (data.success) {
                    showNotification(enabled ? 'âœ… å·²å•Ÿç”¨è¦å‰‡' : 'â¸ï¸ å·²åœç”¨è¦å‰‡', 'success');
                    loadAutoReply();
                } else {
                    showNotification(data.error || 'æ“ä½œå¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('åˆ‡æ›è¦å‰‡å¤±æ•—:', error);
                showNotification('æ“ä½œå¤±æ•—', 'error');
            }
        }

        // æ‰“é–‹æ·»åŠ è¦å‰‡æ¨¡æ…‹æ¡†
        function openAddAutoReplyModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ è‡ªå‹•å›è¦†è¦å‰‡';
            document.getElementById('editRuleId').value = '';
            document.getElementById('triggerInput').value = '';
            document.getElementById('replyInput').value = '';
            document.getElementById('matchTypeSelect').value = 'contains';
            document.getElementById('replyTypeSelect').value = 'message';
            document.getElementById('reactionInput').value = 'ğŸ‘';
            document.getElementById('caseSensitiveCheck').checked = false;
            document.getElementById('mentionUserCheck').checked = false;
            document.getElementById('triggerOnceCheck').checked = false;
            document.getElementById('enabledCheck').checked = true;
            document.getElementById('reactionInputDiv').style.display = 'none';
            document.getElementById('autoReplyModal').style.display = 'flex';
        }

        // ç·¨è¼¯è¦å‰‡
        async function editAutoReplyRule(ruleId) {
            try {
                const response = await fetch('/api/auto-reply/' + GUILD_ID);
                const data = await response.json();
                const rule = data.rules.find(r => r.id === ruleId);
                
                if (!rule) {
                    showNotification('æ‰¾ä¸åˆ°è©²è¦å‰‡', 'error');
                    return;
                }
                
                document.getElementById('modalTitle').textContent = 'ç·¨è¼¯è‡ªå‹•å›è¦†è¦å‰‡ #' + ruleId;
                document.getElementById('editRuleId').value = ruleId;
                document.getElementById('triggerInput').value = rule.trigger || '';
                document.getElementById('replyInput').value = rule.reply || '';
                document.getElementById('matchTypeSelect').value = rule.match_type || 'contains';
                document.getElementById('replyTypeSelect').value = rule.reply_type || 'message';
                document.getElementById('reactionInput').value = rule.reaction || 'ğŸ‘';
                document.getElementById('caseSensitiveCheck').checked = rule.case_sensitive || false;
                document.getElementById('mentionUserCheck').checked = rule.mention_user || false;
                document.getElementById('triggerOnceCheck').checked = rule.trigger_once || false;
                document.getElementById('enabledCheck').checked = rule.enabled !== false;
                document.getElementById('reactionInputDiv').style.display = rule.reply_type === 'react' ? 'block' : 'none';
                document.getElementById('autoReplyModal').style.display = 'flex';
            } catch (error) {
                console.error('è¼‰å…¥è¦å‰‡å¤±æ•—:', error);
                showNotification('è¼‰å…¥è¦å‰‡å¤±æ•—', 'error');
            }
        }

        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeAutoReplyModal() {
            document.getElementById('autoReplyModal').style.display = 'none';
        }

        // åˆ‡æ›åæ‡‰è¼¸å…¥æ¡†é¡¯ç¤º
        function toggleReactionInput(replyType) {
            document.getElementById('reactionInputDiv').style.display = replyType === 'react' ? 'block' : 'none';
        }

        // ä¿å­˜è¦å‰‡
        async function saveAutoReply() {
            const ruleId = document.getElementById('editRuleId').value;
            const trigger = document.getElementById('triggerInput').value.trim();
            const reply = document.getElementById('replyInput').value.trim();
            const matchType = document.getElementById('matchTypeSelect').value;
            const replyType = document.getElementById('replyTypeSelect').value;
            const reaction = document.getElementById('reactionInput').value.trim();
            const caseSensitive = document.getElementById('caseSensitiveCheck').checked;
            const mentionUser = document.getElementById('mentionUserCheck').checked;
            const triggerOnce = document.getElementById('triggerOnceCheck').checked;
            const enabled = document.getElementById('enabledCheck').checked;
            
            if (!trigger) {
                showNotification('è«‹è¼¸å…¥è§¸ç™¼è©', 'error');
                return;
            }
            
            if (replyType !== 'react' && !reply) {
                showNotification('è«‹è¼¸å…¥å›è¦†å…§å®¹', 'error');
                return;
            }
            
            const ruleData = {
                trigger,
                reply: replyType === 'react' ? '' : reply,
                match_type: matchType,
                reply_type: replyType,
                reaction: replyType === 'react' ? reaction : 'ğŸ‘',
                case_sensitive: caseSensitive,
                mention_user: mentionUser,
                trigger_once: triggerOnce,
                enabled,
                channel_ids: [],
                role_ids: []
            };
            
            try {
                let url, method;
                if (ruleId) {  // ç·¨è¼¯
                    url = `/api/auto-reply/${GUILD_ID}/${ruleId}`;
                    method = 'PUT';
                } else {  // æ–°å¢
                    url = `/api/auto-reply/${GUILD_ID}`;
                    method = 'POST';
                }
                
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ruleData)
                });
                const data = await res.json();
                
                if (data.success) {
                    showNotification(ruleId ? 'âœ… è¦å‰‡å·²æ›´æ–°' : 'âœ… è¦å‰‡å·²æ·»åŠ ', 'success');
                    closeAutoReplyModal();
                    loadAutoReply();
                } else {
                    showNotification(data.error || 'æ“ä½œå¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±æ•—:', error);
                showNotification('æ“ä½œå¤±æ•—', 'error');
            }
        }

        // åˆªé™¤è¦å‰‡
        async function deleteAutoReplyRule(ruleId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¦å‰‡å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼')) return;
            
            try {
                const res = await fetch(`/api/auto-reply/${GUILD_ID}/${ruleId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    showNotification('âœ… è¦å‰‡å·²åˆªé™¤', 'success');
                    loadAutoReply();
                } else {
                    showNotification(data.error || 'åˆªé™¤å¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('åˆªé™¤å¤±æ•—:', error);
                showNotification('åˆªé™¤å¤±æ•—', 'error');
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        loadStats();
        loadLevels();
        loadDaily();
        loadWelcome();
        loadBirthdays();
        loadGames();
        loadStatistics();
        loadCustomCommands();
        loadTempVoice();
        loadWarnings();
        loadAchievements();
        loadTickets();
        loadAutoReply();
        
        // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ•¸æ“š
        setInterval(() => {
            loadStats();
            loadLevels();
            loadDaily();
            loadWelcome();
            loadBirthdays();
            loadGames();
            loadStatistics();
            loadCustomCommands();
            loadTempVoice();
            loadWarnings();
            loadAchievements();
            loadTickets();
            loadAutoReply();
        }, 30000);
    </script>
</body>
</html>
